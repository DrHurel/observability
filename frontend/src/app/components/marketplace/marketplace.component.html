<div class="marketplace-container">
    <div class="marketplace-header">
        <div class="header-content">
            <h1>üõçÔ∏è Marketplace</h1>
            <p>Discover amazing products from our sellers</p>
        </div>
        <div class="header-actions">
            @if (isLoggedIn()) {
            <a routerLink="/sell" class="btn-sell">+ Sell an Item</a>
            } @else {
            <a routerLink="/login" class="btn-sell">Login to Sell</a>
            }
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="filters-bar">
        <div class="search-box">
            <input type="text" placeholder="Search products..." [(ngModel)]="searchQuery" (ngModelChange)="onSearch()">
            <span class="search-icon">üîç</span>
        </div>
        <div class="filter-buttons">
            <button [class.active]="sortBy() === 'name'" (click)="setSortBy('name')">Name</button>
            <button [class.active]="sortBy() === 'price-low'" (click)="setSortBy('price-low')">Price ‚Üë</button>
            <button [class.active]="sortBy() === 'price-high'" (click)="setSortBy('price-high')">Price ‚Üì</button>
        </div>
        <div class="price-filter">
            <select [(ngModel)]="priceRange" (ngModelChange)="onSearch()">
                <option value="all">All Prices</option>
                <option value="0-50">Under $50</option>
                <option value="50-100">$50 - $100</option>
                <option value="100-500">$100 - $500</option>
                <option value="500+">$500+</option>
            </select>
        </div>
    </div>

    <!-- Results Count -->
    <div class="results-info">
        <span>{{ filteredProducts().length }} products found</span>
        @if (searchQuery) {
        <button class="clear-search" (click)="clearSearch()">Clear search</button>
        }
    </div>

    <!-- Loading State -->
    @if (loading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading products...</p>
    </div>
    }

    <!-- Products Grid -->
    @if (!loading()) {
    <div class="products-grid">
        @for (product of filteredProducts(); track product.id) {
        <div class="product-card" (click)="viewProduct(product)">
            <div class="product-image">
                <span class="placeholder-icon">üì¶</span>
                @if (isExpiringSoon(product)) {
                <span class="badge expiring">Expiring Soon</span>
                }
                @if (product.price >= 100) {
                <span class="badge premium">Premium</span>
                }
            </div>
            <div class="product-info">
                <h3>{{ product.name }}</h3>
                <p class="price">${{ product.price.toFixed(2) }}</p>
                <p class="expiry">Expires: {{ formatDate(product.expirationDate) }}</p>
            </div>
            <div class="product-actions">
                <button class="btn-view" (click)="viewProduct(product); $event.stopPropagation()">
                    View Details
                </button>
                @if (isLoggedIn()) {
                <button class="btn-cart" (click)="addToCart(product); $event.stopPropagation()">
                    üõí
                </button>
                }
            </div>
        </div>
        } @empty {
        <div class="empty-state">
            <span class="empty-icon">üîç</span>
            <h3>No products found</h3>
            <p>Try adjusting your search or filters</p>
        </div>
        }
    </div>
    }

    <!-- Product Modal -->
    @if (selectedProduct()) {
    <div class="modal-overlay" (click)="closeModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <button class="modal-close" (click)="closeModal()">√ó</button>
            <div class="modal-body">
                <div class="modal-image">
                    <span class="placeholder-icon large">üì¶</span>
                </div>
                <div class="modal-info">
                    <h2>{{ selectedProduct()!.name }}</h2>
                    <p class="modal-price">${{ selectedProduct()!.price.toFixed(2) }}</p>
                    <div class="modal-details">
                        <p><strong>Product ID:</strong> {{ selectedProduct()!.id }}</p>
                        <p><strong>Expiration:</strong> {{ formatDate(selectedProduct()!.expirationDate) }}</p>
                    </div>
                    @if (isLoggedIn()) {
                    <div class="modal-actions">
                        <button class="btn-primary" (click)="addToCart(selectedProduct()!)">
                            Add to Cart üõí
                        </button>
                    </div>
                    } @else {
                    <div class="login-prompt">
                        <p>Login to purchase this item</p>
                        <a routerLink="/login" class="btn-primary">Login</a>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Cart Toast -->
    @if (cartMessage()) {
    <div class="cart-toast">
        {{ cartMessage() }}
    </div>
    }
</div>